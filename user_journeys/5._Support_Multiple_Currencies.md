---

**1. Detailed User Journeys and Flows**

*   **Objective:** To capture the step-by-step interactions a user has with the system to achieve a specific business goal.
*   **Requirements:**
    *   Document each distinct and significant user journey.
    *   For each journey, provide a clear, sequential description of user actions and system responses.
    *   Include decision points, alternative paths, and error handling scenarios within the flow.
    *   Visual representation (e.g., flowcharts, sequence diagrams) is highly encouraged to illustrate the flow.
    *   Clearly identify the start and end points of each journey.
    *   If multiple journeys lead to similar outcomes with variations, document these variations.

**User Journey: Managing Multiple Currencies**

This journey explains how the system handles financial data across different currencies.

*   **Core Interactions:** A user creates an account and assigns it a specific currency (e.g., EUR). When recording a transaction with this account in a book whose default currency is different (e.g., USD), the system prompts for a converted amount. For aggregated reports and dashboards, the system automatically converts all values into a single base currency for unified analysis.

*   **Flow:**
    1.  **Initial Data Load:**
        *   On application startup, `CurrencyDataLoader` reads `currency.json` to populate the in-memory `ApplicationScopeBean` with a list of currencies and their exchange rates against USD.
        *   If `currency.json` is unavailable, it loads default values for USD and CNY.
    2.  **Automatic Rate Refresh:**
        *   After the initial data load, `CurrencyRemoteDataLoader` triggers `CurrencyService.refreshCurrency()`.
        *   This service makes an API call to `https://api.exchangerate-api.com/v4/latest/USD` to fetch the latest exchange rates.
        *   The in-memory currency list is updated with the new rates.
    3.  **User-Initiated Actions:**
        *   **Viewing Currencies:** A user can request a list of all supported currencies via the `GET /currencies/all` endpoint.
        *   **Querying Currencies:** A user can query, filter, and paginate currencies through the `GET /currencies` endpoint. They can also get rates relative to a specific base currency.
        *   **Manual Rate Refresh:** A user can trigger a manual refresh of exchange rates by calling `POST /currencies/refresh`.
        *   **Calculating Exchange Rates:** A user can get the exchange rate between two currencies (`GET /currencies/rate`) or calculate the value of a specific amount in another currency (`GET /currencies/calc`).
        *   **Manual Rate Override:** A privileged user can manually update the exchange rate for a specific currency via `PUT /currencies/{id}/rate`.
    4.  **Transactions with Multiple Currencies:**
        *   A user creates an account, specifying a currency (e.g., "EUR").
        *   The user records a transaction in a book with a different default currency (e.g., "USD").
        *   The system detects the currency mismatch and requires the user to input the `convertedAmount`.
        *   The transaction is saved with both the original `amount` (in EUR) and the `convertedAmount` (in USD).
    5.  **Reporting:**
        *   When generating reports or the financial overview, the system uses the `convertedAmount` for all calculations to ensure data is aggregated in a single, consistent currency (the group's default).

**2. Detailed Object Level Data Structures**

*   **Objective:** To meticulously document the structure and attributes of key data entities within the system.
*   **Requirements:**
    *   Identify and list all significant data entities (e.g., Customer, Order, Product, Invoice, User Account).
    *   For each entity, list all its data attributes as they exist in the code or database.
    *   For each attribute, capture:
        *   Attribute Name (exact name from code/database).
        *   Data Type (e.g., `string`, `integer`, `boolean`, `datetime`, `decimal`, `enum`, `complex_object`).
        *   Constraints or Properties (e.g., `NOT NULL`, `UNIQUE`, `PRIMARY KEY`, `FOREIGN KEY`, `maxLength`, `defaultValue`, `isEncrypted`).
        *   A brief description of what the attribute represents.
    *   Indicate relationships between entities where relevant (e.g., One-to-Many, Many-to-Many).

**In-Memory Data Structure: `CurrencyDetails`**

This object is not a database entity but is held in the application's memory (`ApplicationScopeBean`).

| Attribute Name | Data Type | Constraints/Properties | Description |
| :--- | :--- | :--- | :--- |
| `id` | `Integer` | | Unique identifier for the currency. |
| `name` | `String` | | The currency code (e.g., "USD", "EUR"). |
| `description` | `String` | | A descriptive name for the currency. |
| `rate` | `Double` | | The exchange rate relative to USD. |
| `rate2` | `Double` | | A temporary field used to hold the exchange rate relative to a user-specified base currency for queries. |

**Form Data Structure: `ChangeRateForm`**

| Attribute Name | Data Type | Constraints/Properties | Description |
| :--- | :--- | :--- | :--- |
| `base` | `String` | | The base currency for the new rate. |
| `rate` | `BigDecimal` | | The new exchange rate to be set. |

**3. Database Tables to be Updated**

*   **Objective:** To identify which database tables are directly impacted by user actions and system processes.
*   **Requirements:**
    *   For each documented user journey and major functional area, list the specific database tables that are:
        *   Read from (e.g., for data retrieval).
        *   Written to (e.g., `INSERT`, `UPDATE`, `DELETE` operations).
    *   Specify the typical operations performed on each table within the context of the documented functionality.

The currency feature primarily interacts with in-memory data. However, it influences the following database tables:

| Table Name | Operations | Description |
| :--- | :--- | :--- |
| `t_user_account` | `INSERT`, `UPDATE` | The `currency_code` column is set when an account is created or updated. |
| `t_user_book` | `INSERT`, `UPDATE` | The `default_currency_code` column is set when a book is created or updated. |
| `t_user_group` | `INSERT`, `UPDATE` | The `default_currency_code` column is set when a group is created or updated. |
| `t_user_balance_flow` | `INSERT`, `UPDATE` | The `amount` and `converted_amount` columns are populated during transaction creation, especially when there is a currency mismatch. |

**4. Business Rules and Functionality (Detailed)**

*   **Objective:** To capture the explicit and implicit logic that governs the system's behavior and data integrity.
*   **Requirements:**
    *   Provide a detailed description of all identified business rules.
    *   For each rule, specify:
        *   **Rule Name/Identifier:** A concise name for the rule.
        *   **Description:** A clear explanation of the rule.
        *   **Triggering Event:** What action or condition initiates this rule?
        *   **Logic/Conditions:** The specific criteria, calculations, or conditional statements involved.
        *   **Outcome/Action:** What happens when the rule is met or violated?
    *   **Validations (Front-end and Back-end):**
        *   **Front-end Validations:** Detail any checks performed on the user interface to guide user input and provide immediate feedback (e.g., "required field," "email format," "numeric range").
        *   **Back-end Validations:** Detail any checks performed on the server-side to ensure data integrity, security, and adherence to business logic (e.g., "inventory check," "user permissions," "data consistency checks"). For each validation, describe the rule being enforced and the consequence of failure.

| Rule Name/Identifier | Description | Triggering Event | Logic/Conditions | Outcome/Action |
| :--- | :--- | :--- | :--- | :--- |
| **Base Currency** | All exchange rates are maintained relative to a single base currency, USD. | Application Startup, Rate Refresh | The `rate` field in `CurrencyDetails` represents the value of 1 USD in that currency. | Ensures a consistent standard for all conversion calculations. |
| **Currency Conversion** | The system must be able to calculate the exchange rate between any two supported currencies. | `CurrencyService.convert()` | The conversion is calculated via USD as an intermediary: `toRate / fromRate`. | Returns the calculated exchange rate. |
| **Transaction Currency Mismatch** | When a transaction involves different currencies, the converted amount must be provided. | `BalanceFlowService.add()` | `fromAccount.currencyCode != book.defaultCurrencyCode` or `fromAccount.currencyCode != toAccount.currencyCode` (for transfers). | The `convertedAmount` field in the `BalanceFlowAddForm` becomes mandatory. |
| **Reporting Aggregation** | All financial reports and summaries must be presented in a single currency. | `ReportService`, `AccountService.overview()` | When aggregating data, the system uses the `convertedAmount` field from `BalanceFlow` entities. | Provides a unified and accurate financial picture to the user. |
| **Currency Code Validation** | Ensures that any provided currency code is valid and supported by the system. | `CurrencyService.checkCode()` | Checks if the provided code exists in the list of loaded `CurrencyDetails`. | Throws a `FailureMessageException` if the code is not found. |

**5. Detailed Test Cases**

*   **Objective:** To create a comprehensive set of test cases that can verify the correct implementation of user journeys and business rules.
*   **Requirements:**
    *   Develop detailed test cases for each significant user journey and business rule.
    *   Each test case should include:
        *   **Test Case ID:** A unique identifier.
        *   **Feature/User Story/Rule Being Tested:** Clear reference to the item under test.
        *   **Preconditions:** Any setup required before executing the test.
        *   **Test Steps:** A precise, sequential list of actions to perform.
        *   **Test Data:** Specific input data required for the test.
        *   **Expected Result:** The anticipated outcome of performing the test steps with the given data.
    *   Include test cases for:
        *   **Happy Paths:** Valid scenarios.
        *   **Negative Paths:** Invalid inputs and error conditions.
        *   **Boundary Conditions:** Testing limits and edge cases of data inputs.
        *   **Error Handling:** Verifying how the system responds to exceptions and invalid states.

| Test Case ID | Feature Being Tested | Preconditions | Test Steps | Test Data | Expected Result |
| :--- | :--- | :--- | :--- | :--- | :--- |
| CUR-001 | Get All Currencies | Application is running. | Send a `GET` request to `/currencies/all`. | N/A | The system returns a JSON array of all currencies loaded from `currency.json`. |
| CUR-002 | Refresh Rates | Application is running. External API is accessible. | Send a `POST` request to `/currencies/refresh`. | N/A | The system returns `true`. A subsequent call to `/currencies/all` shows updated rates. |
| CUR-003 | Get Exchange Rate | Application is running. | Send a `GET` request to `/currencies/rate`. | `from=USD`, `to=EUR` | The system returns the correct exchange rate between USD and EUR. |
| CUR-004 | Calculate Amount | Application is running. | Send a `GET` request to `/currencies/calc`. | `from=USD`, `to=EUR`, `amount=100` | The system returns the correctly converted amount in EUR. |
| CUR-005 | Transaction with Conversion | User is logged in. A book with default currency USD exists. An account with currency EUR exists. | Create a new expense transaction from the EUR account in the USD book. | `amount=50` (EUR), `convertedAmount=55` (USD) | The transaction is created successfully. The EUR account balance decreases by 50. The expense is recorded as 55 USD in reports. |
| CUR-006 | Invalid Currency Code | User is logged in. | Attempt to create an account with an invalid currency code. | `currencyCode="XYZ"` | The system returns a validation error (`FailureMessageException`). |

**6. State Any Assumptions**

*   **Objective:** To document any assumptions made during the extraction process due to ambiguity or lack of definitive information.
*   **Requirements:**
    *   List all assumptions clearly and concisely.
    *   For each assumption, explain the reasoning or the gap in information that led to it.
    *   These assumptions are critical for understanding the context and potential areas for further investigation.

*   **External API Availability:** It is assumed that the external exchange rate API (`https://api.exchangerate-api.com`) is reliable and continuously available. The application has a basic fallback (logging an error and returning `false`), but no sophisticated circuit breaker or alternative provider logic is implemented.
*   **Accuracy of External Rates:** The accuracy of all currency conversions is dependent on the data provided by the external API. The application trusts this source implicitly.
*   **Manual Conversion Input:** It is assumed that when the system prompts the user for a `convertedAmount`, the user will provide an accurate value. The system does not validate this input against a calculated rate.
*   **Static Currency List:** The set of supported currencies is static and defined in the `currency.json` file. The application does not have a mechanism for dynamically adding or removing supported currencies at runtime.
*   **USD as Base:** The entire currency conversion logic is hardcoded to use USD as the central base currency. Changing this base would require code modifications in `CurrencyService`.

---
