---

**1. Detailed User Journeys and Flows**

*   **Objective:** To capture the step-by-step interactions a user has with the system to achieve the business goal of tracking incomes and expenses.
*   **Note:** The user in this context is an API client. The journey describes the server-side processes triggered by API calls.

---

### Journey 1: Creating a New Transaction (Income/Expense)

*   **Start Point:** The user initiates a `POST` request to the `/balance-flows` endpoint with transaction data.
*   **System Flow:**
    1.  **Controller:** `BalanceFlowController.handleAdd()` receives the `BalanceFlowAddForm` object.
    2.  **Service:** `BalanceFlowService.add()` is called.
    3.  **Pre-checks (`checkBeforeAdd`):**
        *   It validates that for `EXPENSE` or `INCOME` types, the `categories` list is not empty.
        *   It checks for and rejects duplicate categories within the same transaction.
        *   It enforces a limit on the number of categories per transaction (e.g., `Limitation.flow_max_category_count`).
        *   If the transaction `Account`'s currency is different from the `Book`'s default currency, it validates that `convertedAmount` is provided for each category split.
    4.  **Entity Creation:**
        *   A new `BalanceFlow` entity is created from the form data.
        *   The current `User` and `Group` are retrieved from the session and set on the entity.
        *   The `Book` and `Account` are fetched and associated.
    5.  **Amount Calculation:**
        *   The total `amount` for the transaction is calculated by summing the `amount` from each item in the `categories` list.
        *   If currency conversion is needed, the total `convertedAmount` is also summed up.
    6.  **Relation Mapping:**
        *   `CategoryRelationService.addRelation()` is called to create and persist `CategoryRelation` entities, linking the transaction to its categories.
        *   `TagRelationService.addRelation()` is called to create `TagRelation` entities for any specified tags.
        *   If a `Payee` is specified, it is fetched and linked to the transaction.
    7.  **Persistence:** The fully constructed `BalanceFlow` entity (along with its relations) is saved to the database.
    8.  **Balance Update:**
        *   If the `confirm` flag in the form is `true`, the `BalanceFlowService.confirmBalance()` method is called.
        *   This method updates the `balance` field of the associated `Account` entity:
            *   `balance = balance - amount` for an `EXPENSE`.
            *   `balance = balance + amount` for an `INCOME`.
        *   The updated `Account` is saved to the database.
*   **End Point:** The system returns a success response. The transaction is recorded, and the account balance is updated if confirmed.

---

### Journey 2: Creating a Transfer

*   **Start Point:** The user initiates a `POST` request to the `/balance-flows` with `type` as `TRANSFER`.
*   **System Flow:**
    1.  **Controller & Service:** Same as Journey 1.
    2.  **Pre-checks (`checkBeforeAdd`):**
        *   It validates that the `account` (from), `to` (account), and `amount` are all present.
        *   If the 'from' and 'to' accounts have different currencies, it validates that `convertedAmount` is provided.
    3.  **Entity Creation:**
        *   A `BalanceFlow` entity is created. The `from` account is set in the `account` field, and the `to` account is set in the `to` field.
    4.  **Persistence:** The `BalanceFlow` entity is saved.
    5.  **Balance Update (`confirmBalance`):**
        *   If confirmed, the balance of the 'from' `Account` is reduced by `amount`.
        *   The balance of the 'to' `Account` is increased by `convertedAmount` (which equals `amount` if currencies are the same).
        *   Both updated `Account` entities are saved.
*   **End Point:** The system returns a success response. Funds are recorded as moved between the two accounts.

---

### Journey 3: Updating a Transaction

*   **Start Point:** The user initiates a `PUT` request to `/balance-flows/{id}`.
*   **System Flow:**
    1.  **Controller:** `BalanceFlowController.handleUpdate()` receives the request.
    2.  **Service:** `BalanceFlowService.update()` is called.
    3.  **Logic:** The update process is implemented as a "delete and re-add" to ensure data integrity and correct balance recalculations.
        *   The original `BalanceFlow` entity is fetched.
        *   The `remove()` method is called on the original transaction ID. This includes refunding the balance to the account (`refundBalance`).
        *   A new `BalanceFlow` is created by calling the `add()` method with the new form data.
        *   Any `FlowFile` (attachments) from the old transaction are re-associated with the new transaction entity.
*   **End Point:** The system returns the ID of the new transaction record.

---

### Journey 4: Deleting a Transaction

*   **Start Point:** The user initiates a `DELETE` request to `/balance-flows/{id}`.
*   **System Flow:**
    1.  **Controller:** `BalanceFlowController.handleDelete()` receives the request.
    2.  **Service:** `BalanceFlowService.remove()` is called.
    3.  **Balance Refund (`refundBalance`):**
        *   The `BalanceFlow` entity is fetched.
        *   If the transaction was confirmed, the balance change is reverted on the associated `Account`(s).
            *   `balance = balance + amount` for an `EXPENSE`.
            *   `balance = balance - amount` for an `INCOME`.
            *   Balances for both accounts in a `TRANSFER` are reverted.
        *   The updated `Account`(s) are saved.
    4.  **Cascade Delete:**
        *   Associated file attachments (`FlowFile`) are deleted.
        *   The `BalanceFlow` entity is deleted. The `CategoryRelation` and `TagRelation` entities are deleted automatically due to `orphanRemoval=true`.
*   **End Point:** The system returns a success response. The transaction is removed, and the account balance is restored to its previous state.

---

**2. Detailed Object Level Data Structures**

*   **Objective:** To document the structure of key data entities involved in tracking incomes and expenses.

| Entity | Table Name | Attribute Name | Data Type | Constraints/Properties | Description |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **BalanceFlow** | `t_user_balance_flow` | `id` | `Integer` | `PRIMARY KEY` | Unique identifier for the transaction. |
| | | `book` | `Book` | `NOT NULL`, `FOREIGN KEY` | The ledger this transaction belongs to. |
| | | `type` | `FlowType` (Enum) | `NOT NULL` | Type of transaction: `EXPENSE`, `INCOME`, `TRANSFER`, `ADJUST`. |
| | | `amount` | `BigDecimal` | `NOT NULL` | The primary amount of the transaction. |
| | | `convertedAmount` | `BigDecimal` | `NULLABLE` | The amount after currency conversion. |
| | | `account` | `Account` | `NULLABLE`, `FOREIGN KEY` | The source account for the transaction. |
| | | `to` | `Account` | `NULLABLE`, `FOREIGN KEY` | The destination account (for transfers). |
| | | `createTime` | `Long` | `NOT NULL` | The timestamp when the transaction occurred. |
| | | `title` | `String(32)` | `NULLABLE` | A short title for the transaction. |
| | | `notes` | `String(1024)` | `NULLABLE` | Detailed notes. |
| | | `creator` | `User` | `NOT NULL`, `FOREIGN KEY` | The user who created the transaction. |
| | | `group` | `Group` | `NOT NULL`, `FOREIGN KEY` | The group this transaction belongs to. |
| | | `payee` | `Payee` | `NULLABLE`, `FOREIGN KEY` | The payee associated with the transaction. |
| | | `confirm` | `Boolean` | `NOT NULL` | `true` if the transaction affects account balances. |
| | | `include` | `Boolean` | `NULLABLE` | `true` if the transaction should be included in reports. |
| **CategoryRelation** | `t_user_category_relation` | `id` | `Integer` | `PRIMARY KEY` | Unique identifier. |
| | | `category` | `Category` | `NOT NULL`, `FOREIGN KEY` | The category being linked. |
| | | `balanceFlow` | `BalanceFlow` | `NOT NULL`, `FOREIGN KEY` | The transaction being linked. |
| | | `amount` | `BigDecimal` | `NOT NULL` | The portion of the transaction's amount for this specific category. |
| | | `convertedAmount` | `BigDecimal` | `NULLABLE` | The converted amount for this specific category split. |
| **TagRelation** | `t_user_tag_relation` | `id` | `Integer` | `PRIMARY KEY` | Unique identifier. |
| | | `tag` | `Tag` | `NOT NULL`, `FOREIGN KEY` | The tag being linked. |
| | | `balanceFlow` | `BalanceFlow` | `NOT NULL`, `FOREIGN KEY` | The transaction being linked. |
| | | `amount` | `BigDecimal` | `NOT NULL` | The total amount of the transaction this tag is applied to. |
| **Account** | `t_user_account` | `id` | `Integer` | `PRIMARY KEY` | Unique identifier. |
| | | `balance` | `BigDecimal` | `NOT NULL` | The current balance of the account. |
| | | `currencyCode` | `String(8)` | `NOT NULL` | The currency of the account (e.g., "USD"). |

---

**3. Database Tables to be Updated**

*   **Objective:** To identify which database tables are impacted by the "Track Incomes & Expenses" journeys.

| Table Name | Read/Write Operations | Context |
| :--- | :--- | :--- |
| `t_user_balance_flow` | `INSERT`, `DELETE` | A new record is inserted on creation. The record is deleted on update or deletion. |
| `t_user_category_relation` | `INSERT`, `DELETE` | Records are inserted when a transaction with categories is created. They are deleted when the parent transaction is deleted. |
| `t_user_tag_relation` | `INSERT`, `DELETE` | Records are inserted when a transaction with tags is created. They are deleted when the parent transaction is deleted. |
| `t_user_account` | `READ`, `UPDATE` | The `balance` is read and updated when a transaction is confirmed, deleted, or updated. |
| `t_user_book` | `READ` | Read to verify ownership and get default currency. |
| `t_user_category` | `READ` | Read to verify categories exist within the book. |
| `t_user_tag` | `READ` | Read to verify tags exist within the book. |
| `t_user_payee` | `READ` | Read to verify payee exists within the book. |
| `t_flow_file` | `UPDATE`, `DELETE` | Updated when a transaction is updated (to re-link files). Deleted when a transaction is deleted. |

---

**4. Business Rules and Functionality (Detailed)**

*   **Objective:** To capture the logic that governs the creation and management of transactions.

| Rule Name/Identifier | Description | Triggering Event | Logic/Conditions | Outcome/Action |
| :--- | :--- | :--- | :--- | :--- |
| **Category Requirement** | Expenses and Incomes must be categorized. | Creating an `EXPENSE` or `INCOME` transaction. | `categories` list in the form is null or empty. | Throw `FailureMessageException` ("add.flow.category.empty"). |
| **No Duplicate Categories** | A single transaction cannot be assigned to the same category twice. | Creating a transaction. | The list of category relations contains duplicate category IDs. | Throw `FailureMessageException` ("add.flow.category.duplicated"). |
| **Foreign Currency Amount** | For accounts in a foreign currency, a converted amount must be supplied for each category. | Creating an `EXPENSE` or `INCOME` from a foreign currency account. | `account.currencyCode` != `book.defaultCurrencyCode` AND `category.convertedAmount` is null. | Throw `FailureMessageException` ("valid.fail"). |
| **Transfer Requirements** | A transfer must have from/to accounts and an amount. | Creating a `TRANSFER` transaction. | `account`, `to`, or `amount` is null. | Throw `FailureMessageException` ("valid.fail"). |
| **Cross-Currency Transfer** | A transfer between accounts with different currencies requires a converted amount. | Creating a `TRANSFER` transaction. | `fromAccount.currencyCode` != `toAccount.currencyCode` AND `convertedAmount` is null. | Throw `FailureMessageException` ("valid.fail"). |
| **Balance Confirmation** | Account balances are only updated for confirmed transactions. | Creating, updating, or deleting a transaction. | The `confirm` flag on the `BalanceFlow` entity is `true`. | The `confirmBalance()` or `refundBalance()` methods are executed to modify the `Account.balance`. |
| **Update Integrity** | Updating a transaction preserves data integrity by replacing the old record. | Updating a transaction. | `BalanceFlowService.update()` is called. | The old transaction is deleted (refunding its balance), and a new one is created. |

---

**5. Detailed Test Cases**

*   **Objective:** To create test cases to verify the correct implementation of the transaction tracking functionality.

| Test Case ID | Feature Being Tested | Preconditions | Test Steps | Test Data | Expected Result |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TC-001** | Happy Path: Create Confirmed Expense | User is logged in. A `Book` and an `Account` (USD, balance: 1000) exist. | 1. Send `POST /balance-flows`. <br> 2. Verify response is success. <br> 3. Fetch the account and check its balance. | `type: EXPENSE`, `amount: 50`, `confirm: true`, `account: (ID)`, `categories: [...]` | 1. API returns HTTP 200. <br> 2. The account balance is now 950. |
| **TC-002** | Happy Path: Create Unconfirmed Expense | Same as TC-001. | 1. Send `POST /balance-flows`. | `type: EXPENSE`, `amount: 50`, `confirm: false` | 1. API returns HTTP 200. <br> 2. The account balance remains 1000. |
| **TC-003** | Happy Path: Create Confirmed Transfer | Two accounts exist: AcctA (USD, bal: 1000), AcctB (USD, bal: 500). | 1. Send `POST /balance-flows`. | `type: TRANSFER`, `account: (AcctA ID)`, `to: (AcctB ID)`, `amount: 100`, `confirm: true` | 1. API returns HTTP 200. <br> 2. AcctA balance is 900. <br> 3. AcctB balance is 600. |
| **TC-004** | Negative Path: Expense without Category | User is logged in. | 1. Send `POST /balance-flows`. | `type: EXPENSE`, `amount: 50`, `categories: []` | API returns an error (e.g., HTTP 400) with message "add.flow.category.empty". |
| **TC-005** | Negative Path: Cross-Currency Transfer without Converted Amount | AcctA (USD), AcctB (EUR). | 1. Send `POST /balance-flows`. | `type: TRANSFER`, `account: (AcctA ID)`, `to: (AcctB ID)`, `amount: 100`, `convertedAmount: null` | API returns an error (e.g., HTTP 400) with message "valid.fail". |
| **TC-006** | Deletion Test | A confirmed expense of 50 exists. Account balance is 950. | 1. Send `DELETE /balance-flows/{id}` for the expense. <br> 2. Fetch the account and check its balance. | N/A | 1. API returns HTTP 200. <br> 2. The account balance is restored to 1000. |
| **TC-007** | Update Test | A confirmed expense of 50 exists. Account balance is 950. | 1. Send `PUT /balance-flows/{id}` to change the amount to 70. <br> 2. Fetch the account and check its balance. | `amount: 70` | 1. API returns HTTP 200. <br> 2. The account balance is now 930. |

---

**6. State Any Assumptions**

*   **Session Management:** It is assumed that `SessionUtil` correctly and securely provides the context of the currently authenticated `User` and their active `Group`. All service-layer logic relies on this context for data scoping and authorization.
*   **Data Authorization:** It is assumed that the `BaseService` (e.g., `findAccountById`, `getBookInGroup`) correctly enforces that a user can only access entities belonging to their group. The `BalanceFlowService` itself does not re-verify ownership of every single entity ID passed into it, relying on the base service.
*   **Frontend Responsibility:** It is assumed that the client (frontend) is responsible for fetching currency exchange rates and suggesting the `convertedAmount` to the user where applicable. The backend's role is to validate the presence of this field when required, not to calculate it.
*   **Entity Existence:** Test cases assume that the entities referenced by ID in the `BalanceFlowAddForm` (e.g., `book`, `account`, `payee`, `tags`) exist and are accessible to the user. The service logic will throw `ItemNotFoundException` if they don't, but this is the expected error path.

