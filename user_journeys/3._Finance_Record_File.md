---

**1. Detailed User Journeys and Flows**

*   **Objective:** To capture the step-by-step interactions a user has with the system to achieve a specific business goal related to financial record files.
*   **Journeys Documented:**
    1.  Attaching a Supporting Document to a Transaction.
    2.  Viewing/Downloading an Attached Document.
    3.  Listing all Documents for a Transaction.
    4.  Deleting an Attached Document.
    5.  Exporting Transaction History to an Excel File.

---

### Journey 1: Attaching a Supporting Document to a Transaction

*   **Description:** A user uploads a digital file (e.g., a receipt image, a PDF invoice) and links it to a specific financial transaction (`BalanceFlow`) for record-keeping and proof of purchase.
*   **Start Point:** User is viewing the details of an existing transaction or is in the process of creating a new one.
*   **End Point:** The file is successfully uploaded, associated with the transaction, and the user receives confirmation.
*   **Flow:**
    1.  **User Action:** The user clicks an "Add Attachment" or "Upload File" button on the transaction details page.
    2.  **System Response:** A file selection dialog appears.
    3.  **User Action:** The user selects a file from their local device.
    4.  **System Response:** The front-end initiates a `POST` request to the `/api/v1/balance-flows/{id}/addFile` endpoint, where `{id}` is the ID of the transaction. The request is a multipart/form-data request containing the file.
    5.  **Backend Process (`BalanceFlowService.addFile`):**
        *   The system receives the `MultipartFile`.
        *   A new `FlowFile` entity is created.
        *   The file's binary data is read using `file.getBytes()` and stored in the `FlowFile`'s `data` field.
        *   Metadata is extracted and saved: `originalName`, `contentType`, `size`.
        *   The current user is set as the `creator` and the current time as `createTime`.
        *   The `FlowFile` is linked to the parent `BalanceFlow` transaction.
        *   The `FlowFile` entity is persisted to the `t_flow_file` table.
    6.  **System Response:** The backend returns a JSON object with the details of the newly created `FlowFile`, confirming the successful upload. The UI then updates to show the new file in the list of attachments for that transaction.

*   **Visual Representation (Sequence Diagram):**
    ```mermaid
    sequenceDiagram
        participant User
        participant FrontEnd
        participant BackEnd (API)
        participant Database

        User->>FrontEnd: Clicks "Add Attachment" & Selects File
        FrontEnd->>BackEnd: POST /balance-flows/{id}/addFile (multipart/form-data)
        BackEnd->>BackEnd: Create FlowFile entity
        BackEnd->>BackEnd: Set data, metadata, creator, flow
        BackEnd->>Database: INSERT INTO t_flow_file
        Database-->>BackEnd: Success
        BackEnd-->>FrontEnd: 200 OK (FlowFileDetails JSON)
        FrontEnd->>User: Display new file in attachment list
    ```

---

### Journey 2: Viewing/Downloading an Attached Document

*   **Description:** A user accesses a previously uploaded file to view its content.
*   **Start Point:** User is viewing the list of attachments for a transaction.
*   **End Point:** The file is displayed in the browser or downloaded to the user's device.
*   **Flow:**
    1.  **User Action:** The user clicks on the name of an attached file.
    2.  **System Response:** The front-end constructs and initiates a `GET` request to `/api/v1/flow-files/view` with the file's `id` and `createTime` as query parameters.
    3.  **Backend Process (`FlowFileService.getFile`):**
        *   The system retrieves the `FlowFile` by its `id`.
        *   **Security Check:** It validates that the `createTime` from the request URL matches the `createTime` stored on the `FlowFile` entity. This prevents enumeration attacks where an attacker could guess sequential file IDs. If they don't match, an exception is thrown.
    4.  **Backend Process (`FlowFileController.handleView`):**
        *   The controller receives the validated `FlowFile` entity.
        *   It builds a response with the file's binary `data`.
        *   It sets the `Content-Type` header of the response to the `contentType` stored for the file (e.g., `image/jpeg`, `application/pdf`).
    5.  **System Response:** The browser receives the file data and, based on the content type, either displays it directly (for images, PDFs) or prompts the user to download it.

---

### Journey 3: Deleting an Attached Document

*   **Description:** A user permanently removes an attachment from a transaction.
*   **Start Point:** User is viewing the list of attachments for a transaction.
*   **End Point:** The file is deleted, and the attachment list is updated.
*   **Flow:**
    1.  **User Action:** The user clicks a "Delete" or "Remove" icon next to a file attachment.
    2.  **System Response:** The front-end sends a `DELETE` request to `/api/v1/flow-files/{id}`, where `{id}` is the ID of the `FlowFile`.
    3.  **Backend Process (`FlowFileService.remove`):**
        *   The system retrieves the `FlowFile` entity by its ID.
        *   **Authorization Check:** It retrieves the associated `BalanceFlow` transaction and verifies that the current user has the right to access it (i.e., it belongs to their group).
        *   If authorized, the system deletes the `FlowFile` record from the database.
    4.  **System Response:** The backend returns a success status. The UI removes the file from the attachment list.

---

### Journey 4: Exporting Transaction History to an Excel File

*   **Description:** A user exports the complete transaction history of a specific "Book" for offline analysis, backup, or reporting.
*   **Start Point:** User is in the "Manage Books" section of the application.
*   **End Point:** An Excel (`.xlsx`) file is downloaded to the user's device.
*   **Flow:**
    1.  **User Action:** The user clicks the "Export" button for a specific book.
    2.  **System Response:** The front-end sends a `GET` request to `/api/v1/books/{id}/export`, including the user's timezone offset as a query parameter (e.g., `?timeZoneOffset=-5`).
    3.  **Backend Process (`BookService.exportFlow`):**
        *   The system retrieves all `BalanceFlow` transactions for the given book ID, ordered by creation time.
        *   It initializes a memory-efficient `SXSSFWorkbook` (Apache POI).
        *   A header row is created with internationalized column titles (e.g., "Title", "Type", "Amount", "Time").
        *   The service iterates through each transaction and maps its details to a new row in the spreadsheet.
        *   **Timezone Conversion:** The transaction's `createTime` (a UTC timestamp) is formatted into a human-readable date string, adjusted according to the `timeZoneOffset` provided in the request.
        *   The completed workbook is written to the HTTP response stream with the appropriate `Content-Type` for an Excel file.
    4.  **System Response:** The browser prompts the user to save the generated `.xlsx` file.

---

**2. Detailed Object Level Data Structures**

*   **Objective:** To document the structure of the key data entity for finance record files.

### Entity: `FlowFile`

*   **Database Table:** `t_flow_file`
*   **Description:** Represents a single file attachment linked to a financial transaction.

| Attribute Name | Data Type | Constraints / Properties | Description |
| :--- | :--- | :--- | :--- |
| `id` | `Integer` | `PRIMARY KEY`, `AUTO_INCREMENT` | Unique identifier for the file record. |
| `data` | `byte[]` | `NOT NULL`, `@Lob`, `LONGBLOB`, `FetchType.LAZY` | The actual binary content of the file. Lazily loaded for performance. |
| `creator` | `User` | `NOT NULL`, `FOREIGN KEY` to `t_user_user`, `FetchType.LAZY` | The user who uploaded the file. |
| `flow` | `BalanceFlow` | `FOREIGN KEY` to `t_user_balance_flow`, `FetchType.LAZY` | The transaction this file is attached to. |
| `createTime` | `Long` | `NOT NULL` | The Java `System.currentTimeMillis()` timestamp of the upload. |
| `contentType` | `String` | `NOT NULL`, `maxLength=32` | The MIME type of the file (e.g., "image/png"). |
| `size` | `Long` | `NOT NULL` | The size of the file in bytes. |
| `originalName` | `String` | `NOT NULL`, `maxLength=512` | The original name of the file as it was on the user's device. |

*   **Relationships:**
    *   **Many-to-One:** A `FlowFile` belongs to one `User` (its creator).
    *   **Many-to-One:** A `FlowFile` belongs to one `BalanceFlow` (the transaction).
    *   **One-to-Many:** A `BalanceFlow` can have many `FlowFile`s.

---

**3. Database Tables to be Updated**

*   **Objective:** To identify which database tables are impacted by the finance record file functionality.

| Table Name | Operations | Context / Trigger |
| :--- | :--- | :--- |
| `t_flow_file` | `INSERT` | A new file is uploaded via the `POST /balance-flows/{id}/addFile` endpoint. |
| `t_flow_file` | `SELECT` | A user views a file (`GET /flow-files/view`) or lists all files for a transaction (`GET /balance-flows/{id}/files`). |
| `t_flow_file` | `DELETE` | A user deletes a file (`DELETE /flow-files/{id}`), or the parent transaction (`BalanceFlow`) is deleted, which triggers a cascading delete of its files. |
| `t_user_balance_flow` | `SELECT` | Read to verify user permissions before allowing a file to be deleted or viewed. Also read when exporting data. |
| `t_user_book` | `SELECT`, `UPDATE` | Read to get all transactions for export. Updated with the `exportAt` timestamp after an export is completed. |

---

**4. Business Rules and Functionality (Detailed)**

*   **Objective:** To capture the logic and validations governing the finance record file features.

| Rule Name/Identifier | Description | Triggering Event | Logic/Conditions | Outcome/Action |
| :--- | :--- | :--- | :--- | :--- |
| **File Size Limit** | Restricts the size of uploaded files to prevent abuse and manage storage. | File Upload | **Back-end Validation:** The `spring.servlet.multipart.max-file-size` property in `application.properties` is set to `100MB`. | If a file exceeds 100MB, the request is rejected by the Spring framework before it reaches the controller, resulting in an error. |
| **File Type Validation** | Ensures that only supported file types (images, PDFs) can be uploaded. | File Upload | **Back-end Validation:** A custom `@ValidFile` annotation (as per context documents) checks the file's `Content-Type`. Supported types are likely `image/jpeg`, `image/png`, `application/pdf`. | If the file's content type is not in the allowed list, the upload is rejected with a validation error. |
| **File View Security** | Prevents unauthorized file access by guessing sequential IDs. | File View/Download | **Back-end Validation:** The `GET /flow-files/view` endpoint requires both the file `id` and its `createTime`. The service layer (`FlowFileService`) verifies that the provided `createTime` matches the timestamp stored in the database for that `id`. | If the `createTime` does not match, the request is denied, even if the `id` is correct. |
| **Cascading Delete** | Ensures data integrity by removing file attachments when their parent transaction is deleted. | Transaction Deletion | **Back-end Logic:** When `BalanceFlowService.remove()` is called for a transaction, it explicitly calls `flowFileRepository.deleteByFlow(entity)` before deleting the transaction itself. | All `FlowFile` records associated with the deleted `BalanceFlow` are removed from the `t_flow_file` table. |
| **Export Timezone** | Ensures exported timestamps are accurate for the user's local time. | Data Export | **Back-end Logic:** The `BookService.exportFlow()` method accepts a `timeZoneOffset` parameter. It uses this offset to adjust the UTC `createTime` of each transaction before formatting it as a string for the Excel file. | The "Time" column in the exported `.xlsx` file reflects the user's local time, not the server's time. |
| **Export Rate Limiting** | Prevents users from repeatedly exporting the same data, which can be a resource-intensive operation. | Data Export | **Back-end Logic (partially disabled):** The `BookService.exportFlow()` method updates an `exportAt` timestamp on the `Book` entity. A commented-out check suggests the original intent was to throw an error if an export was attempted within 24 hours of the last one. | The system records when an export occurs. If the rate-limiting logic were enabled, subsequent requests within the time limit would fail. |

---

**5. Detailed Test Cases**

*   **Objective:** To create test cases for verifying the correct implementation of the finance record file journeys and rules.

| Test Case ID | Feature Being Tested | Preconditions | Test Steps | Test Data | Expected Result |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TC-FF-001** | **Happy Path:** File Upload | User is logged in. A transaction with ID `123` exists. | 1. Navigate to transaction `123`. <br> 2. Click "Add Attachment". <br> 3. Select `receipt.jpg`. <br> 4. Submit. | `receipt.jpg` (Size: 50KB, Type: `image/jpeg`) | File uploads successfully. The `t_flow_file` table has a new record linked to transaction `123`. The UI shows `receipt.jpg` in the attachment list. |
| **TC-FF-002** | **Negative:** File Size Limit | User is logged in. | 1. Attempt to upload `large_file.zip`. | `large_file.zip` (Size: 110MB) | The upload fails with a "Maximum upload size exceeded" error. |
| **TC-FF-003** | **Negative:** File Type Validation | User is logged in. | 1. Attempt to upload `malicious.exe`. | `malicious.exe` (Type: `application/octet-stream`) | The upload is rejected with a "File type not supported" validation error. |
| **TC-FF-004** | **Happy Path:** File View | A `FlowFile` with ID `456` and `createTime` `1678886400000` exists. | 1. Make a GET request to `/flow-files/view?id=456&createTime=1678886400000`. | `id=456`, `createTime=1678886400000` | The request succeeds. The response body contains the file's binary data with the correct `Content-Type` header. |
| **TC-FF-005** | **Negative:** File View Security | A `FlowFile` with ID `456` and `createTime` `1678886400000` exists. | 1. Make a GET request to `/flow-files/view?id=456&createTime=9999999999999`. | `id=456`, `createTime=9999999999999` | The request fails with an error, and no file data is returned. |
| **TC-FF-006** | **Happy Path:** File Deletion | A `FlowFile` with ID `789` exists and belongs to the user's group. | 1. Make a DELETE request to `/flow-files/789`. | `id=789` | The request succeeds. The record for file `789` is removed from the `t_flow_file` table. |
| **TC-FF-007** | **Happy Path:** Data Export | A book with ID `1` exists and contains 3 transactions. | 1. Make a GET request to `/books/1/export?timeZoneOffset=-8`. | `id=1`, `timeZoneOffset=-8` | An `.xlsx` file is downloaded. The file contains a header row and 3 data rows. The timestamps in the "Time" column are adjusted for GMT-8. |
| **TC-FF-008** | **Boundary:** Export Empty Book | A book with ID `2` exists and has no transactions. | 1. Make a GET request to `/books/2/export?timeZoneOffset=0`. | `id=2`, `timeZoneOffset=0` | An `.xlsx` file is downloaded. The file contains only the header row. |

---

**6. State Any Assumptions**

*   **Front-End Implementation:** It is assumed that a functional front-end exists to facilitate user interactions, such as providing upload buttons, displaying file lists, and making the correct API calls.
*   **Authentication/Authorization:** It is assumed that a robust authentication and group-based authorization layer is already in place, and all service methods are executed within the context of an authenticated user session. The `FlowFile` logic relies on this to authorize actions.
*   **Configuration:** It is assumed that the `application.properties` file is correctly configured, especially the `spring.servlet.multipart.max-file-size` property, and that this configuration is applied by the running environment.
*   **Dependencies:** It is assumed that all necessary libraries, particularly Apache POI for Excel export, are correctly included in the project's build file and are available at runtime.
*   **File Validation Annotation:** Based on context files, it's assumed the `@ValidFile` annotation is correctly implemented and applied somewhere in the validation chain, even if not directly on the controller method signature reviewed.

