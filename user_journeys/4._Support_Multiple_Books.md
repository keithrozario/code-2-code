---

**1. Detailed User Journeys and Flows**

*   **Objective:** To capture the step-by-step interactions a user has with the system to achieve the specific business goal of managing multiple, independent financial ledgers (Books).
*   **Requirements:**
    *   Document each distinct and significant user journey related to managing Books.
    *   For each journey, provide a clear, sequential description of user actions and system responses.
    *   Include decision points, alternative paths, and error handling scenarios within the flow.
    *   Clearly identify the start and end points of each journey.

---

### Journey 1: Creating a New Book

**Objective:** User wants to create a new, separate ledger to track a specific area of their finances (e.g., a new business, a side project, a vacation).

**Start Point:** User is logged in and navigates to the "Manage Books" section of the application.

**User Actions & System Responses:**

1.  **User Action:** Clicks the "Add Book" button.
2.  **System Response:** The system presents the user with three options for creation:
    *   Create a blank book from scratch.
    *   Create from a predefined template (e.g., "Daily Life", "Restaurant Business").
    *   Create by copying an existing book.

---

#### Flow 1.1: Create a Blank Book

1.  **User Action:** Selects "Create from Scratch". Fills in a form with:
    *   Book Name (e.g., "Personal Finances")
    *   Default Currency (e.g., "USD")
    *   (Optional) Notes and default accounts.
2.  **System Response (API: `POST /books`):**
    *   The system validates that the book name is not a duplicate within the user's current group.
    *   It checks if the user is allowed to create more books (not exceeding a system limit).
    *   A new `Book` record is created in the `t_user_book` table.
    *   The user is redirected to the list of books, where the new "Personal Finances" book is now visible.

#### Flow 1.2: Create from a Template

1.  **User Action:** Selects "Create from Template". Chooses a template (e.g., "Restaurant Business") from a list. Fills in the Book Name ("My Cafe") and confirms.
2.  **System Response (API: `POST /books/template`):**
    *   The system performs the same initial validations as in Flow 1.1.
    *   It creates the new `Book` record.
    *   It reads the `book_tpl.json` file to find the "Restaurant Business" template definition.
    *   It then programmatically creates and saves new `Category`, `Tag`, and `Payee` records associated with the new "My Cafe" book, based on the template's content.
    *   The user sees the new "My Cafe" book, pre-populated with relevant categories like "Raw Materials" and "Wages".

#### Flow 1.3: Create by Copying an Existing Book

1.  **User Action:** Selects "Create by Copying". Chooses an existing book to copy (e.g., "2024 Business"). Fills in the new Book Name ("2025 Business").
2.  **System Response (API: `POST /books/copy`):**
    *   The system performs initial validations as in Flow 1.1.
    *   It creates the new `Book` record ("2025 Business").
    *   It retrieves all `Category`, `Tag`, and `Payee` records from the source book ("2024 Business").
    *   It creates new `Category`, `Tag`, and `Payee` records that are exact duplicates of the source records but associated with the new "2025 Business" book.
    *   The user sees the new "2025 Business" book with the identical structure as the previous year's book.

**End Point:** A new book exists in the system and is ready for use.

---

### Journey 2: Switching the Active Book

**Objective:** User wants to switch from recording transactions in one book to another (e.g., from "Personal" to "Business").

**Start Point:** User is logged in and working within the context of a specific book.

**User Actions & System Responses:**

1.  **User Action:** Clicks on the book switcher UI element (e.g., a dropdown menu in the header) and selects a different book from the list (e.g., "My Cafe").
2.  **System Response (API: `PATCH /setDefaultBook/{id}`):**
    *   The system updates the user's session, setting the selected book as the new "active" or "default" book.
    *   The application UI refreshes. All subsequent views (dashboards, transaction lists, category lists) now show data scoped exclusively to the "My Cafe" book. Any new transactions created will be recorded in "My Cafe".

**End Point:** The user's context is switched, and all subsequent actions are performed within the newly selected book.

---

### Journey 3: Deleting a Book

**Objective:** User wants to permanently remove a book that is no longer needed.

**Start Point:** User is in the "Manage Books" section.

**User Actions & System Responses:**

1.  **User Action:** Clicks the "Delete" button next to a book they wish to remove.
2.  **System Response (API: `DELETE /books/{id}`):**
    *   **Error Path:** The system first checks if any `BalanceFlow` (transaction) records are associated with this book. If transactions exist, the operation is blocked, and an error message is displayed: "This book cannot be deleted because it contains transactions."
    *   **Success Path:** If no transactions exist, the system proceeds to delete all `Category`, `Tag`, and `Payee` records associated with the book. Finally, it deletes the `Book` record itself.
    *   The user sees the book disappear from the list.

**End Point:** The book and its associated structural data (categories, tags, payees) are permanently removed from the system.

**2. Detailed Object Level Data Structures**

*   **Objective:** To meticulously document the structure and attributes of the core `Book` data entity and its related Data Transfer Objects (DTOs).

---

### Entity: `Book`

**Database Table:** `t_user_book`

| Attribute Name | Data Type | Constraints / Properties | Description |
| :--- | :--- | :--- | :--- |
| `id` | `Integer` | `PRIMARY KEY`, `AUTO_INCREMENT` | Unique identifier for the book. |
| `name` | `String` | `NOT NULL` | The user-defined name of the book. Must be unique within a `Group`. |
| `group_id` | `Integer` | `NOT NULL`, `FOREIGN KEY` to `t_user_group` | The group to which this book belongs. |
| `notes` | `String(1024)` | `NULLABLE` | Optional user-provided notes about the book. |
| `enable` | `Boolean` | `NOT NULL`, `defaultValue: true` | A flag to enable or disable the book. Disabled books are hidden from most views. |
| `defaultExpenseAccount_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_account` | The default account to use when creating a new expense. |
| `defaultIncomeAccount_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_account` | The default account to use when creating a new income. |
| `defaultTransferFromAccount_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_account` | The default source account for transfers. |
| `defaultTransferToAccount_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_account` | The default destination account for transfers. |
| `defaultExpenseCategory_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_category` | The default category for new expenses. |
| `defaultIncomeCategory_id` | `Integer` | `NULLABLE`, `FOREIGN KEY` to `t_user_category` | The default category for new incomes. |
| `defaultCurrencyCode` | `String(8)` | `NOT NULL` | The default currency for this book (e.g., "USD", "EUR"). |
| `exportAt` | `Long` | `NULLABLE` | A timestamp (epoch milliseconds) of the last time the book's data was exported. |
| `sort` | `Integer` | `NULLABLE` | A number used for custom sorting of books in the UI. |

### DTOs (Data Transfer Objects)

*   **`BookAddForm`**: Used for creating a new book from scratch. Contains `name`, `defaultCurrencyCode`, optional default account IDs, `notes`, and `sort`.
*   **`BookUpdateForm`**: Used for updating an existing book. Contains the same fields as `BookAddForm` plus default category IDs.
*   **`BookAddByTemplateForm`**: Wraps a `BookAddForm` and includes a `templateId` to specify which template to use for creation.
*   **`BookAddByBookForm`**: Wraps a `BookAddForm` and includes a `bookId` to specify which existing book to copy.

**3. Database Tables to be Updated**

*   **Objective:** To identify which database tables are directly impacted by the "Support Multiple Books" functionality.

| Table Name | Operations | Context / Trigger |
| :--- | :--- | :--- |
| `t_user_book` | `INSERT`, `UPDATE`, `DELETE`, `SELECT` | The primary table for all book management operations (Create, Read, Update, Delete). |
| `t_user_category` | `INSERT`, `DELETE`, `SELECT` | Records are inserted when creating a book from a template or copying a book. Records are deleted when a book is deleted. |
| `t_user_tag` | `INSERT`, `DELETE`, `SELECT` | Records are inserted when creating a book from a template or copying a book. Records are deleted when a book is deleted. |
| `t_user_payee` | `INSERT`, `DELETE`, `SELECT` | Records are inserted when creating a book from a template or copying a book. Records are deleted when a book is deleted. |
| `t_user_user` | `UPDATE`, `SELECT` | The `default_book_id` column is updated when a user switches their active book. |
| `t_user_balance_flow` | `SELECT` | This table is queried to check for the existence of transactions before allowing a book to be deleted. |

**4. Business Rules and Functionality (Detailed)**

*   **Objective:** To capture the explicit and implicit logic that governs the behavior of the multi-book feature.

| Rule Name/Identifier | Description | Triggering Event | Logic/Conditions | Outcome/Action |
| :--- | :--- | :--- | :--- | :--- |
| **Book Uniqueness** | A book's name must be unique within its parent group. | Creating or updating a book. | `bookRepository.existsByGroupAndName(group, form.getName())` | Throws `ItemExistsException` if a book with the same name already exists in the group. |
| **Book Deletion Constraint** | A book cannot be deleted if it contains any financial transactions. | Deleting a book. | `balanceFlowRepository.existsByBook(entity)` | Throws `FailureMessageException` with the message "book.delete.has.flow". |
| **Default Book Protection** | The group's designated default book cannot be disabled or deleted. | Disabling or deleting a book. | Check if `group.getDefaultBook().getId().equals(id)`. | Throws `FailureMessageException`. This is primarily enforced by disabling the UI button. |
| **Max Book Limit** | A user's group cannot have more than a predefined maximum number of books. | Creating a new book. | `bookRepository.countByGroup(group) >= Limitation.book_max_count` | Throws `FailureMessageException` with the message "book.max.count". |
| **Default Book Fallback** | When a book is disabled, any user who has it set as their default book will be reassigned the group's default book. | Disabling a book. | `userRepository.findByDefaultBook(entity)` | The system finds all affected users and updates their `default_book_id` to the group's default book ID. |
| **Book Creation from Template** | A new book can be pre-populated with a structure defined in a JSON file. | Creating a book via the template flow. | Reads `book_tpl.json`, finds the matching template by ID, and iterates through its `categories`, `tags`, and `payees`. | Creates new records in the `t_user_category`, `t_user_tag`, and `t_user_payee` tables, linking them to the newly created book. |
| **Book Creation by Copying** | A new book can be created as a structural clone of an existing book. | Creating a book via the copy flow. | Fetches all `categories`, `tags`, and `payees` from the source book. | Creates new records in the corresponding tables that are duplicates of the source records but linked to the new book ID. |
| **Data Isolation** | All core financial data (`BalanceFlow`, `Category`, `Tag`, `Payee`) is strictly scoped to a single book. | Any data creation or query operation. | All repository queries are filtered by the `book_id` of the user's currently active book. | A user only ever sees or interacts with data from one book at a time. |

**5. Detailed Test Cases**

*   **Objective:** To create a set of test cases to verify the correct implementation of the multi-book functionality.

| Test Case ID | Feature Being Tested | Preconditions | Test Steps | Test Data | Expected Result |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TC-BOOK-01** | Create Book (Happy Path) | User is logged in. | 1. Navigate to "Manage Books". 2. Click "Add Book". 3. Enter a unique name and select a currency. 4. Click "Save". | Name: "Vacation Fund", Currency: "EUR" | The "Vacation Fund" book appears in the list. |
| **TC-BOOK-02** | Create Book (Negative Path) | Book "Personal" already exists. | 1. Navigate to "Manage Books". 2. Click "Add Book". 3. Enter the name "Personal". 4. Click "Save". | Name: "Personal" | An error message "Item already exists" is displayed. The book is not created. |
| **TC-BOOK-03** | Delete Book (Negative Path) | Book "Business" has at least one transaction. | 1. Navigate to "Manage Books". 2. Click "Delete" next to the "Business" book. | - | An error message "This book cannot be deleted because it contains transactions" is displayed. The book is not deleted. |
| **TC-BOOK-04** | Delete Book (Happy Path) | Book "Old Project" has no transactions. | 1. Navigate to "Manage Books". 2. Click "Delete" next to the "Old Project" book. | - | The "Old Project" book is removed from the list. |
| **TC-BOOK-05** | Switch Active Book | User has two books: "Personal" (active) and "Business". | 1. Click the book switcher. 2. Select "Business". | - | The UI refreshes. The dashboard and transaction list now show data only from the "Business" book. |
| **TC-BOOK-06** | Create from Template | User selects the "Daily Life" template. | 1. Navigate to "Manage Books". 2. Click "Add from Template". 3. Select "Daily Life". 4. Name the book "My Life". 5. Click "Save". | Template: "Daily Life", Name: "My Life" | The "My Life" book is created. When selected, it already contains categories like "Food", "Housing", etc. |
| **TC-BOOK-07** | Create by Copying | Book "2024 Taxes" exists with 10 categories. | 1. Navigate to "Manage Books". 2. Click "Copy Book". 3. Select "2024 Taxes" as the source. 4. Name the new book "2025 Taxes". 5. Click "Save". | Source: "2024 Taxes", Name: "2025 Taxes" | The "2025 Taxes" book is created and has the exact same 10 categories as the source book. |

**6. State Any Assumptions**

*   **User Roles and Permissions:** It is assumed that the user performing these actions has the necessary permissions within their `Group` (e.g., 'Owner' or 'Operator') to create, manage, and delete books. The specific role-based access control (RBAC) logic is handled at the `Group` level and is not detailed here.
*   **System Limits:** The existence of a `Limitation.book_max_count` constant is noted. The actual value of this limit is assumed to be configured elsewhere and is not specified in the analyzed code.
*   **UI Implementation:** The documentation of user journeys assumes a standard web application UI with buttons, forms, and dropdowns that correspond to the available API endpoints. The exact UI implementation details are inferred.
*   **Session Management:** It is assumed that the user's active `Group` and `Book` are managed in a server-side session (`SessionUtil`) and are correctly populated after login and during context switching.

