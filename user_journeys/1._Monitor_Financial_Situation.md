---

**1. Detailed User Journeys and Flows**

*   **Objective:** To capture the step-by-step interactions a user has with the system to achieve a specific business goal.
*   **Requirements:**
    *   Document each distinct and significant user journey.
    *   For each journey, provide a clear, sequential description of user actions and system responses.
    *   Include decision points, alternative paths, and error handling scenarios within the flow.
    *   Visual representation (e.g., flowcharts, sequence diagrams) is highly encouraged to illustrate the flow.
    *   Clearly identify the start and end points of each journey.
    *   If multiple journeys lead to similar outcomes with variations, document these variations.

**User Journey 1: View Financial Overview**

*   **Objective:** To get a quick, high-level snapshot of their overall financial health.
*   **Starting Point:** User is logged into the application.
*   **End Point:** User has viewed their total assets, debts, and net worth.

**Flow:**

1.  **User Action:** The user navigates to the main "Dashboard" or "Overview" section of the application.
2.  **System Response (API Call):** The frontend makes a `GET` request to the `/api/v1/accounts/overview` endpoint.
3.  **System Processing (Backend):**
    *   The `AccountController` receives the request and calls the `AccountService.overview()` method.
    *   The service retrieves all accounts for the user's current group that are marked as `enable=true` and `include=true`.
    *   It separates accounts into "Assets" (`CHECKING`, `ASSET`) and "Debts" (`CREDIT`, `DEBT`).
    *   For each account, it converts the `balance` to the user's group default currency using the `CurrencyService`.
    *   It calculates the sum of all asset balances and the sum of all debt balances.
    *   It calculates the net worth (Assets - Debts).
    *   The backend returns a JSON array with three `BigDecimal` values: `[totalAssets, totalDebts, netWorth]`.
4.  **System Response (UI):** The frontend receives the data and displays the three key figures prominently. It may also render pie charts for asset and debt breakdowns using a separate call to `GET /api/v1/reports/balance`.

**User Journey 2: Analyze Spending by Category**

*   **Objective:** To understand spending habits by viewing a report of expenses broken down by category.
*   **Starting Point:** User is logged into the application and has selected a "Book".
*   **End Point:** User has viewed a chart and data table showing their spending per category for a given period.

**Flow:**

1.  **User Action:** The user navigates to the "Reports" section and selects the "Expense by Category" report. They may optionally filter by a date range (e.g., "This Month").
2.  **System Response (API Call):** The frontend makes a `GET` request to `/api/v1/reports/expense-category` with query parameters like `book=1&minTime=1662004800000&maxTime=1664596799000`.
3.  **System Processing (Backend):**
    *   The `ReportController` receives the request and calls `ReportService.reportCategory()` with `CategoryType.EXPENSE`.
    *   The service fetches all `CategoryRelation` records that match the filter criteria (book, date range, etc.) from confirmed and included transactions.
    *   It groups the results by parent category and sums the `convertedAmount` for each group.
    *   It calculates the percentage of the total for each category.
    *   The backend returns a JSON array of `ChartVO` objects, where each object contains the category name (`x`), total amount (`y`), and percentage (`percent`).
4.  **System Response (UI):** The frontend renders a bar chart or pie chart based on the `ChartVO` data and displays a corresponding data table.

---

**2. Detailed Object Level Data Structures**

*   **Objective:** To meticulously document the structure and attributes of key data entities within the system.
*   **Requirements:**
    *   Identify and list all significant data entities (e.g., Customer, Order, Product, Invoice, User Account).
    *   For each entity, list all its data attributes as they exist in the code or database.
    *   For each attribute, capture:
        *   Attribute Name (exact name from code/database).
        *   Data Type (e.g., `string`, `integer`, `boolean`, `datetime`, `decimal`, `enum`, `complex_object`).
        *   Constraints or Properties (e.g., `NOT NULL`, `UNIQUE`, `PRIMARY KEY`, `FOREIGN KEY`, `maxLength`, `defaultValue`, `isEncrypted`).
        *   A brief description of what the attribute represents.
    *   Indicate relationships between entities where relevant (e.g., One-to-Many, Many-to-Many).

**Entity: `Account` (Table: `t_user_account`)**

| Attribute Name | Data Type | Constraints/Properties | Description |
| :--- | :--- | :--- | :--- |
| `id` | `Integer` | `PRIMARY KEY`, `AUTO_INCREMENT` | Unique identifier for the account. |
| `group` | `Group` | `NOT NULL`, `FOREIGN KEY` to `t_user_group` | The group this account belongs to. |
| `name` | `String` | `NOT NULL` | The user-defined name of the account (e.g., "Chase Checking"). |
| `type` | `AccountType` (Enum) | `NOT NULL` | Type of account. Can be `CHECKING`, `CREDIT`, `DEBT`, `ASSET`. |
| `notes` | `String` | `maxLength=1024` | User-provided notes for the account. |
| `enable` | `Boolean` | `NOT NULL` | Whether the account is active and can be used. |
| `no` | `String` | `maxLength=32` | Account number or card number. |
| `balance` | `BigDecimal` | `NOT NULL` | The current balance of the account. |
| `include` | `Boolean` | `NOT NULL` | Whether to include this account in financial overviews. |
| `canExpense` | `Boolean` | `NOT NULL` | Whether this account can be used for expense transactions. |
| `canIncome` | `Boolean` | `NOT NULL` | Whether this account can be used for income transactions. |
| `canTransferFrom` | `Boolean` | `NOT NULL` | Whether funds can be transferred from this account. |
| `canTransferTo` | `Boolean` | `NOT NULL` | Whether funds can be transferred to this account. |
| `currencyCode` | `String` | `NOT NULL`, `maxLength=8` | The currency code for the account (e.g., "USD", "EUR"). |
| `initialBalance` | `BigDecimal` | | The starting balance of the account. |
| `creditLimit` | `BigDecimal` | | The credit limit for credit-type accounts. |
| `billDay` | `Integer` | | The day of the month the bill is generated for credit accounts. |
| `apr` | `BigDecimal` | | Annual Percentage Rate for credit/debt accounts. |
| `sort` | `Integer` | | A number used for custom sorting of accounts. |

**DTO: `ChartVO`**

This Data Transfer Object is used to structure data for frontend charts.

| Attribute Name | Data Type | Description |
| :--- | :--- | :--- |
| `x` | `String` | The label for a data point (e.g., a category name like "Groceries"). |
| `y` | `BigDecimal` | The numerical value for a data point (e.g., total spending amount). |
| `percent` | `BigDecimal` | The percentage this data point represents out of the total. |

---

**3. Database Tables to be Updated**

*   **Objective:** To identify which database tables are directly impacted by user actions and system processes.
*   **Requirements:**
    *   For each documented user journey and major functional area, list the specific database tables that are:
        *   Read from (e.g., for data retrieval).
        *   Written to (e.g., `INSERT`, `UPDATE`, `DELETE` operations).
    *   Specify the typical operations performed on each table within the context of the documented functionality.

The "Monitor Financial Situation" journey is **primarily a read-only operation**. No data is inserted, updated, or deleted. The system reads from multiple tables to aggregate and present the financial overview and reports.

**Tables Read From:**

| Table Name | Operation | Purpose in Journey |
| :--- | :--- | :--- |
| `t_user_account` | `SELECT` | To retrieve account details, including `balance`, `currencyCode`, `type`, `enable`, and `include` status for the financial overview and balance reports. |
| `t_user_group` | `SELECT` | To get the current user's group and its default currency code, which is essential for currency conversion. |
| `t_user_balance_flow` | `SELECT`, `SUM` | To get transaction data for generating reports on spending and income by payee. |
| `t_user_category_relation` | `SELECT`, `SUM` | To get transaction amounts linked to specific categories for category-based reports. |
| `t_user_tag_relation` | `SELECT`, `SUM` | To get transaction amounts linked to specific tags for tag-based reports. |
| `t_user_category` | `SELECT` | To retrieve category names and their hierarchical structure for report labels. |
| `t_user_tag` | `SELECT` | To retrieve tag names and their hierarchical structure for report labels. |
| `t_user_payee` | `SELECT` | To retrieve payee names for payee-based reports. |

---

**4. Business Rules and Functionality (Detailed)**

*   **Objective:** To capture the explicit and implicit logic that governs the system's behavior and data integrity.
*   **Requirements:**
    *   Provide a detailed description of all identified business rules.
    *   For each rule, specify:
        *   **Rule Name/Identifier:** A concise name for the rule.
        *   **Description:** A clear explanation of the rule.
        *   **Triggering Event:** What action or condition initiates this rule?
        *   **Logic/Conditions:** The specific criteria, calculations, or conditional statements involved.
        *   **Outcome/Action:** What happens when the rule is met or violated?
    *   **Validations (Front-end and Back-end):**
        *   **Front-end Validations:** Detail any checks performed on the user interface to guide user input and provide immediate feedback (e.g., "required field," "email format," "numeric range").
        *   **Back-end Validations:** Detail any checks performed on the server-side to ensure data integrity, security, and adherence to business logic (e.g., "inventory check," "user permissions," "data consistency checks"). For each validation, describe the rule being enforced and the consequence of failure.

**Business Rules**

| Rule Name/Identifier | Description | Triggering Event | Logic/Conditions | Outcome/Action |
| :--- | :--- | :--- | :--- | :--- |
| **BR-MON-01: Net Worth Calculation** | Defines how a user's net worth is calculated for the financial overview. | User requests the `/accounts/overview` endpoint. | `Net Worth = (Sum of Asset Balances) - (Sum of Debt Balances)`. Balances are first converted to the group's default currency. | A `BigDecimal` array containing total assets, total debts, and net worth is returned. |
| **BR-MON-02: Asset Aggregation** | Specifies which accounts are considered "assets". | Calculation of total assets for the overview. | Accounts with `type` = `CHECKING` or `ASSET`, `enable` = `true`, and `include` = `true` are summed. | The total value of all included asset accounts is calculated. |
| **BR-MON-03: Debt Aggregation** | Specifies which accounts are considered "debts". | Calculation of total debts for the overview. | Accounts with `type` = `CREDIT` or `DEBT`, `enable` = `true`, and `include` = `true` are summed. | The total value of all included debt accounts is calculated. |
| **BR-MON-04: Report Currency Consistency** | Ensures all monetary values in a report are in the same currency. | User requests any financial report (e.g., `/reports/expense-category`). | All transaction amounts (`amount` and `convertedAmount`) are aggregated using the `convertedAmount` field, which is stored in the book's default currency. | The report displays all values in a single, consistent currency, preventing incorrect totals. |
| **BR-MON-05: Hierarchical Report Aggregation** | Defines how reports handle parent-child category/tag relationships. | User requests a category or tag report without specifying a sub-category/tag. | The report sums the values of the parent category/tag and all its descendants. | The report shows an aggregated total for the top-level item, providing a complete picture. |

**Validations**

*   **Backend Validation:**
    *   **Rule:** A `book` ID must be provided when requesting a category-based report.
    *   **Implementation:** The `CategoryReportQueryForm` has a `@NotNull` annotation on the `book` field.
    *   **Consequence of Failure:** The API will return a `400 Bad Request` error with a validation message.

---

**5. Detailed Test Cases**

*   **Objective:** To create a comprehensive set of test cases that can verify the correct implementation of user journeys and business rules.
*   **Requirements:**
    *   Develop detailed test cases for each significant user journey and business rule.
    *   Each test case should include:
        *   **Test Case ID:** A unique identifier.
        *   **Feature/User Story/Rule Being Tested:** Clear reference to the item under test.
        *   **Preconditions:** Any setup required before executing the test.
        *   **Test Steps:** A precise, sequential list of actions to perform.
        *   **Test Data:** Specific input data required for the test.
        *   **Expected Result:** The anticipated outcome of performing the test steps with the given data.
    *   Include test cases for:
        *   **Happy Paths:** Valid scenarios.
        *   **Negative Paths:** Invalid inputs and error conditions.
        *   **Boundary Conditions:** Testing limits and edge cases of data inputs.
        *   **Error Handling:** Verifying how the system responds to exceptions and invalid states.

| Test Case ID | Feature Being Tested | Preconditions | Test Steps | Test Data | Expected Result |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **TC-MON-001** | **Happy Path:** Financial Overview | - User is logged in. <br>- Group default currency is USD. <br>- User has 3 accounts: <br>  1. Checking (Asset): $1000 USD, `include=true` <br>  2. Savings (Asset): €500 EUR, `include=true` <br>  3. Credit Card (Debt): -$200 USD, `include=true` <br>- Exchange rate: 1 EUR = 1.10 USD. | 1. Make a `GET` request to `/api/v1/accounts/overview`. | N/A | The API returns `[1550.00, 200.00, 1350.00]`. <br>(Assets: 1000 + 500*1.10 = 1550) <br>(Debts: 200) <br>(Net Worth: 1550 - 200 = 1350) |
| **TC-MON-002** | **Boundary:** Account Not Included | Same as TC-MON-001, but the "Savings" account has `include=false`. | 1. Make a `GET` request to `/api/v1/accounts/overview`. | N/A | The API returns `[1000.00, 200.00, 800.00]`. The savings account is ignored. |
| **TC-MON-003** | **Happy Path:** Category Report | - User is logged in. <br>- A book with ID `1` exists. <br>- Two confirmed expense transactions exist in book 1: <br>  1. $50 in "Food" category. <br>  2. $100 in "Travel" category. | 1. Make a `GET` request to `/api/v1/reports/expense-category?book=1`. | `book=1` | The API returns a JSON array of `ChartVO` objects, one for "Food" with `y=50` and one for "Travel" with `y=100`. |
| **TC-MON-004** | **Negative Path:** Report Missing Book ID | User is logged in. | 1. Make a `GET` request to `/api/v1/reports/expense-category`. | (No `book` parameter) | The API returns a `400 Bad Request` status code due to the missing required `book` parameter. |
| **TC-MON-005** | **Boundary:** Report with No Data | - User is logged in. <br>- A book with ID `2` exists but has no transactions. | 1. Make a `GET` request to `/api/v1/reports/expense-category?book=2`. | `book=2` | The API returns an empty JSON array `[]`. |

---

**6. State Any Assumptions**

*   **Objective:** To document any assumptions made during the extraction process due to ambiguity or lack of definitive information.
*   **Requirements:**
    *   List all assumptions clearly and concisely.
    *   For each assumption, explain the reasoning or the gap in information that led to it.
    *   These assumptions are critical for understanding the context and potential areas for further investigation.

*   **Assumption 1:** The `CurrencyService` is assumed to have access to up-to-date exchange rates. If the external API fails or provides stale data, the financial overview and reports will be inaccurate.
*   **Assumption 2:** The user's session (`SessionUtil`) correctly identifies the current user and their active group. All data access for monitoring is scoped to this group, so any issue in session management would lead to incorrect data being shown.
*   **Assumption 3:** The frontend UI is responsible for correctly interpreting the API responses (e.g., `ChartVO` arrays) and rendering them into user-friendly charts and tables. The backend only provides the structured data.
*   **Assumption 4:** For hierarchical reports (e.g., categories with sub-categories), it is assumed that the user intends to see an aggregated total for a parent category if they select it, which includes all its children. This is based on the logic in `ReportService.reportCategory`.
*   **Assumption 5:** The term "Monitoring" is interpreted as a read-only activity. The user journeys documented here do not involve creating or modifying any financial data, only viewing aggregated reports of existing data.

