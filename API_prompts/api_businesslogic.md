Of course. I will start by analyzing the repository to understand its business logic. First, I'll read the `README.md` file to get a high-level overview of the project.The `README.md` confirms `moneynote-api` is a backend for an accounting application with features like multiple books, currencies, and reporting. I'll now analyze the `Account` entity's business logic by examining `Account.java`, `AccountController.java`, and `AccountService.java`, starting with the `Account.java` data model to understand validation, calculations, and error handling.Okay, `AccountController.java` is next. I'm checking its endpoints and security.Okay, `AccountService.java` is next. I'm diving in to find the core business logic: validation, calculations, and error handling.Okay, I've analyzed the `Account` Java files and understand the business logic. I'll create the requested documentation table. First, I need to investigate the custom validation annotations: `AccountNoField`, `BalanceField`, `AccountCurrencyCodeField`, and `BillDayField`.Okay, reading annotation files now to understand validation rules.I have analyzed the requested files and have a good understanding of the business logic. I will now present the information in a table format as requested.

### End-to-End Business Process Summary

The `moneynote-api` repository provides the backend for a personal and small business accounting application. The core business process revolves around managing financial accounts. This includes:

1.  **Account Creation:** Users can create various types of accounts (e.g., checking, savings, credit, loan). Each account belongs to a "group" (which can be thought of as a user or a family) and has a specific currency.
2.  **Account Management:** Users can update account details, such as the name, notes, and associated flags (e.g., whether it can be used for expenses, income, or transfers).
3.  **Balance Adjustments:** The system allows for direct adjustments to an account's balance. When an adjustment is made, a corresponding "balance flow" record is created to track the change.
4.  **Account Inquiry:** Users can query for a list of their accounts, view individual account details, and get statistical summaries of their financial situation (e.g., total assets, total debts, and net worth).
5.  **Account Deletion:** Accounts can be deleted, but only if they are not associated with any transactions and are not set as the default account for any "book" (a sub-ledger within the system).

### Detailed Business Logic Analysis

| Business Logic Category | Rule Description | Relevant Code Snippet(s) |
| :--- | :--- | :--- |
| **Validation Rules** | **Account Limit:** A user (or "group") cannot have more than a predefined maximum number of accounts. | `if (accountRepository.countByGroup(group) >= Limitation.account_max_count) { throw new FailureMessageException("account.max.count"); }` in `AccountService.add()` |
| | **Unique Account Name:** Within the same group, each account must have a unique name. | `if (accountRepository.existsByGroupAndName(group, form.getName())) { throw new ItemExistsException(); }` in `AccountService.add()` and `AccountService.update()` |
| | **Valid Currency:** If the account's currency is different from the group's default currency, it must be a valid currency code. | `if (!Objects.equals(group.getDefaultCurrencyCode(), account.getCurrencyCode())) { currencyService.checkCode(form.getCurrencyCode()); }` in `AccountService.add()` |
| | **Account Number Format:** The account number (`no`) has a maximum length of 32 characters and cannot start or end with a space. | `@Size(max = 32) @NotStartsWithSpace @NotEndsWithSpace` on `Account.no` (from `@AccountNoField`) |
| | **Balance Format:** All balance-related fields (e.g., `balance`, `initialBalance`, `creditLimit`) must be a number with a maximum of 20 integer digits and 2 fractional digits. | `@Digits(integer = 20, fraction = 2)` on `Account.balance`, `Account.initialBalance`, `Account.creditLimit` (from `@BalanceField`) |
| | **Currency Code Format:** The currency code must be between 2 and 5 characters long and cannot start or end with a space. | `@Size(max = 5) @Size(min = 2) @NotStartsWithSpace @NotEndsWithSpace` on `Account.currencyCode` (from `@AccountCurrencyCodeField`) |
| | **Bill Day Range:** The bill day of the month must be between 1 and 31. | `@Min(1) @Max(31)` on `Account.billDay` (from `@BillDayField`) |
| **Calculation/Transformation Logic** | **Balance Adjustment:** When a user adjusts an account's balance, the system calculates the difference between the new balance and the old balance. This difference is then recorded as a new "balance flow" transaction of type `ADJUST`. | `BigDecimal adjustAmount = form.getBalance().subtract(entity.getBalance());` and `flow.setAmount(adjustAmount);` in `AccountService.adjustBalance()` |
| | **Currency Conversion:** When querying for account details, the system converts the account's balance to the group's default currency using the current exchange rate. | `details.setRate(currencyService.convert(details.getCurrencyCode(), sessionUtil.getCurrentGroup().getDefaultCurrencyCode())); details.setConvertedBalance(details.getBalance().multiply(details.getRate()).setScale(2, RoundingMode.CEILING));` in `AccountService.query()` and `AccountService.get()` |
| | **Financial Statistics:** The system calculates total assets, total debts, and net worth. It does this by summing the balances of all accounts, converting each to the group's default currency. | `for (Account account : accounts) { balance = balance.add(currencyService.convert(account.getBalance(), account.getCurrencyCode(), group.getDefaultCurrencyCode())); }` in `AccountService.statistics()` and `AccountService.overview()` |
| **Conditional Logic (Edge Cases)** | **Updating Account Name:** When updating an account, the system checks if the name has been changed. If it has, it then verifies that the new name is unique within the group. | `if (!entity.getName().equals(form.getName())) { if (StringUtils.hasText(form.getName())) { if (accountRepository.existsByGroupAndName(group, form.getName())) { throw new ItemExistsException(); } } }` in `AccountService.update()` |
| | **Balance Adjustment - No Change:** If the user attempts to adjust the balance to the same value it already has, the system throws an error and does not create a new transaction. | `if (adjustAmount.signum() == 0) throw new FailureMessageException("account.adjust.balance.same");` in `AccountService.adjustBalance()` |
| **Error Handling** | **Account Deletion with Associated Transactions:** An account cannot be deleted if it has any associated balance flow records (transactions). | `if (balanceFlowRepository.existsByAccountOrTo(entity, entity)) { throw new FailureMessageException("account.delete.fail.has.flow"); }` in `AccountService.remove()` |
| | **Default Account Deletion/Disabling:** An account cannot be deleted or disabled if it is set as the default expense, income, or transfer account for any "book". | `if (bookRepository.existsByDefaultExpenseAccount(entity)) { throw new FailureMessageException("account.action.DefaultExpenseAccount"); }` (and similar checks) in `AccountService.remove()` and `AccountService.toggle()` |
| | **Item Exists:** When a user tries to create an account with a name that already exists in the group, an `ItemExistsException` is thrown. | `throw new ItemExistsException();` in `AccountService.add()` and `AccountService.update()` |
| | **Failure Message:** For most other business rule violations, a `FailureMessageException` is thrown with a message key that can be used for internationalization (i18n). | `throw new FailureMessageException("account.max.count");` in `AccountService.add()` |
